<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½çœ é€±æœŸè¨ˆç®—å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¢ºä¿å­—é«”å’ŒåŸºæœ¬èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #0f172a; /* bg-slate-900 */
            color: #f1f5f9; /* text-slate-100 */
        }
        /* éš±è—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
        input[type=text] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center relative">

    <!-- èªè¨€é¸æ“‡å™¨ -->
    <div class="absolute top-4 right-4 z-10">
        <select id="language-selector" class="bg-slate-700 text-sm text-white p-2 rounded-lg border border-slate-600 focus:ring-2 focus:ring-purple-500">
            <option value="zh-TW">ä¸­æ–‡</option>
            <option value="en-US">English</option>
            <option value="ja-JP">æ—¥æœ¬èª</option>
            <option value="ko-KR">í•œêµ­ì–´</option>
        </select>
    </div>

    <div id="app-container" class="w-full max-w-md mt-10">

        <!-- æ¨™é¡Œå€ -->
        <div class="mb-6 flex items-center justify-center space-x-2 py-4">
            <span class="text-purple-400 text-2xl">ğŸŒ™</span>
            <h1 id="app-title" class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                å¥½çœ é€±æœŸè¨ˆç®—
            </h1>
        </div>

        <!-- åŠŸèƒ½åˆ‡æ›æŒ‰éˆ• -->
        <div class="grid grid-cols-3 gap-2 p-1 bg-slate-800 rounded-xl" id="mode-selector">
        </div>

        <!-- è¼¸å…¥å€å¡Š -->
        <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700/50 backdrop-blur-sm mt-6">
            <div id="input-area">
            </div>

            <!-- å…¥ç¡æ™‚é–“é–‹é—œ -->
            <div id="latency-toggle" class="mt-8 flex items-center justify-center space-x-3 bg-slate-900/50 p-3 rounded-lg cursor-pointer hover:bg-slate-900 transition-colors" onclick="toggleLatency()">
            </div>
            <p id="latency-hint" class="text-xs text-center text-slate-500 mt-2 hidden">
               *è¨ˆç®—çµæœå°‡åŒ…å«å¾èººä¸‹åˆ°å¯¦éš›å…¥ç¡çš„é ä¼°æ™‚é–“
            </p>
        </div>

        <!-- çµæœåˆ—è¡¨ -->
        <div class="space-y-3 pb-10 mt-6">
            <h2 class="text-lg font-semibold text-slate-200 px-2 flex items-center justify-between">
                <span id="results-title">å»ºè­°æ™‚é–“</span>
                <span id="result-hint" class="text-xs font-normal text-slate-400 bg-slate-800 px-2 py-1 rounded"></span>
            </h2>

            <div id="results-list" class="space-y-3">
            </div>
        </div>
        
        <!-- åº•éƒ¨èªªæ˜ -->
        <div id="app-footer" class="text-xs text-slate-600 text-center max-w-xs leading-relaxed">
            ä¸€å€‹å®Œæ•´çš„ç¡çœ é€±æœŸç´„ç‚º 90 åˆ†é˜ã€‚åœ¨é€±æœŸçµæŸæ™‚é†’ä¾†ï¼Œå¤§è…¦æœ€æ¸…é†’ï¼Œèƒ½æœ‰æ•ˆé¿å…èµ·åºŠæ°£èˆ‡ç–²å€¦æ„Ÿã€‚
        </div>

    </div>

    <script>
        // --- ç¿»è­¯è³‡æ–™ ---
        const translations = {
            'zh-TW': {
                lang_name: 'ç¹é«”ä¸­æ–‡', title: 'å¥½çœ é€±æœŸè¨ˆç®—',
                mode_sleep: 'å¹¾é»ç¡è¦º', mode_wake: 'æˆ‘è¦èµ·åºŠ', mode_now: 'ç¾åœ¨ç¡è¦º',
                label_wake: 'æ‚¨é è¨ˆå¹¾é»èµ·åºŠï¼Ÿ', label_sleep: 'æ‚¨é è¨ˆå¹¾é»ä¸ŠåºŠç¡è¦ºï¼Ÿ', label_current_time: 'ç›®å‰æ™‚é–“',
                label_hour: 'å¹¾é»', label_minute: 'å¹¾åˆ†',
                latency_label: 'å¢åŠ  15 åˆ†é˜å…¥ç¡ç·©è¡', latency_hint: '*è¨ˆç®—çµæœå°‡åŒ…å«å¾èººä¸‹åˆ°å¯¦éš›å…¥ç¡çš„é ä¼°æ™‚é–“',
                results_title: 'å»ºè­°æ™‚é–“', hint_wake: 'æ‚¨æ‡‰è©²åœ¨é€™äº›æ™‚é–“èººä¸‹', hint_sleep: 'æ‚¨æ‡‰è©²åœ¨é€™äº›æ™‚é–“èµ·åºŠ',
                cycles: 'å€‹é€±æœŸ', hours: 'å°æ™‚',
                status_short_1: 'åš´é‡ä¸è¶³', status_desc_1: 'éå¸¸å±éšªï¼Œé•·æœŸå°‡æå®³å¥åº·',
                status_short_2: 'å‹‰å¼·æ¥å—', status_desc_2: 'æœ‰é»å±éšªï¼Œä¸å»ºè­°é•·æœŸæŒçºŒ',
                status_short_3: 'ç¡çœ å……è¶³', status_desc_3: 'å®‰å…¨ç„¡ç–‘ï¼Œç²¾ç¥é£½æ»¿',
                footer: 'ä¸€å€‹å®Œæ•´çš„ç¡çœ é€±æœŸç´„ç‚º 90 åˆ†é˜ã€‚åœ¨é€±æœŸçµæŸæ™‚é†’ä¾†ï¼Œå¤§è…¦æœ€æ¸…é†’ï¼Œèƒ½æœ‰æ•ˆé¿å…èµ·åºŠæ°£èˆ‡ç–²å€¦æ„Ÿã€‚'
            },
            'en-US': {
                lang_name: 'English', title: 'Sleep Cycle Calculator',
                mode_sleep: 'When to Sleep', mode_wake: 'When to Wake', mode_now: 'Sleep Now',
                label_wake: 'When do you plan to wake up?', label_sleep: 'When do you plan to go to bed?', label_current_time: 'Current Time',
                label_hour: 'Hour', label_minute: 'Minute',
                latency_label: 'Add 15 min sleep latency', latency_hint: '*Results include estimated time from lying down to falling asleep.',
                results_title: 'Recommended Times', hint_wake: 'You should lie down at these times', hint_sleep: 'You should wake up at these times',
                cycles: 'cycles', hours: 'hours',
                status_short_1: 'Critically Low', status_desc_1: 'Highly dangerous, can damage health long-term',
                status_short_2: 'Barely Acceptable', status_desc_2: 'Slightly risky, not recommended long-term',
                status_short_3: 'Adequate Sleep', status_desc_3: 'Safe and sound, full of energy',
                footer: 'A full sleep cycle is about 90 minutes. Waking at the end of a cycle, the brain is clearest, effectively avoiding grogginess and fatigue.'
            },
            'ja-JP': {
                lang_name: 'æ—¥æœ¬èª', title: 'ç†Ÿç¡ã‚µã‚¤ã‚¯ãƒ«è¨ˆç®—',
                mode_sleep: 'å°±å¯æ™‚é–“', mode_wake: 'èµ·åºŠæ™‚é–“', mode_now: 'ä»Šã™ãå¯ã‚‹',
                label_wake: 'ä½•æ™‚ã«èµ·åºŠäºˆå®šã§ã™ã‹ï¼Ÿ', label_sleep: 'ä½•æ™‚ã«å¯ã‚‹äºˆå®šã§ã™ã‹ï¼Ÿ', label_current_time: 'ç¾åœ¨æ™‚åˆ»',
                label_hour: 'æ™‚', label_minute: 'åˆ†',
                latency_label: '15åˆ†é–“ã®å…¥çœ æ½œæ™‚ã‚’è¿½åŠ ', latency_hint: '*æ¨ªã«ãªã£ã¦ã‹ã‚‰å®Ÿéš›ã«å¯ã‚‹ã¾ã§ã®æ¨å®šæ™‚é–“ã‚’å«ã¿ã¾ã™ã€‚',
                results_title: 'æ¨å¥¨æ™‚é–“', hint_wake: 'ã“ã®æ™‚é–“ã«æ¨ªã«ãªã‚‹ã¹ãã§ã™', hint_sleep: 'ã“ã®æ™‚é–“ã«èµ·ãã‚‹ã¹ãã§ã™',
                cycles: 'ã‚µã‚¤ã‚¯ãƒ«', hours: 'æ™‚é–“',
                status_short_1: 'æ·±åˆ»ãªä¸è¶³', status_desc_1: 'éå¸¸ã«å±é™ºã€é•·æœŸçš„ã«å¥åº·ã‚’æãªã†æã‚ŒãŒã‚ã‚Šã¾ã™',
                status_short_2: 'ã‹ã‚ã†ã˜ã¦è¨±å®¹', status_desc_2: 'ã‚„ã‚„å±é™ºã€é•·æœŸç¶™ç¶šã¯éæ¨å¥¨',
                status_short_3: 'ååˆ†ãªç¡çœ ', status_desc_3: 'å®‰å…¨ã§ç¢ºå®Ÿã€ç²¾åŠ›æº€ã€…',
                footer: 'å®Œå…¨ãªç¡çœ ã‚µã‚¤ã‚¯ãƒ«ã¯ç´„90åˆ†ã§ã™ã€‚ã‚µã‚¤ã‚¯ãƒ«ã®çµ‚ã‚ã‚Šã«ç›®è¦šã‚ã‚‹ã¨ã€è„³ãŒæœ€ã‚‚è¦šé†’ã—ã€çœ æ°—ã‚„ç–²åŠ´æ„Ÿã‚’åŠ¹æœçš„ã«é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚'
            },
            'ko-KR': {
                lang_name: 'í•œêµ­ì–´', title: 'ìˆ˜ë©´ ì£¼ê¸° ê³„ì‚°ê¸°',
                mode_sleep: 'ì·¨ì¹¨ ì‹œê°„', mode_wake: 'ê¸°ìƒ ì‹œê°„', mode_now: 'ì§€ê¸ˆ ì·¨ì¹¨',
                label_wake: 'ëª‡ ì‹œì— ì¼ì–´ë‚  ì˜ˆì •ì¸ê°€ìš”?', label_sleep: 'ëª‡ ì‹œì— ì ìë¦¬ì— ë“¤ ì˜ˆì •ì¸ê°€ìš”?', label_current_time: 'í˜„ì¬ ì‹œê°„',
                label_hour: 'ì‹œ', label_minute: 'ë¶„',
                latency_label: '15ë¶„ ìˆ˜ë©´ ëŒ€ê¸°ì‹œê°„ ì¶”ê°€', latency_hint: '*ëˆ„ìš´ í›„ ì‹¤ì œ ì ë“¤ê¸°ê¹Œì§€ì˜ ì˜ˆìƒ ì‹œê°„ì´ í¬í•¨ë©ë‹ˆë‹¤.',
                results_title: 'ê¶Œì¥ ì‹œê°„', hint_wake: 'ì´ ì‹œê°„ì— ëˆ„ì›Œì•¼ í•©ë‹ˆë‹¤', hint_sleep: 'ì´ ì‹œê°„ì— ì¼ì–´ë‚˜ì•¼ í•©ë‹ˆë‹¤',
                cycles: 'ì£¼ê¸°', hours: 'ì‹œê°„',
                status_short_1: 'ì‹¬ê°í•œ ë¶€ì¡±', status_desc_1: 'ì¥ê¸°ì ìœ¼ë¡œ ê±´ê°•ì„ í•´ì¹  ìˆ˜ ìˆëŠ” ë§¤ìš° ìœ„í—˜í•œ ìƒíƒœ',
                status_short_2: 'ê°„ì‹ íˆ í—ˆìš©', status_desc_2: 'ì¥ê¸°ì ìœ¼ë¡œëŠ” ê¶Œì¥ë˜ì§€ ì•ŠëŠ” ì•½ê°„ ìœ„í—˜í•œ ìƒíƒœ',
                status_short_3: 'ì¶©ë¶„í•œ ìˆ˜ë©´', status_desc_3: 'ì•ˆì „í•˜ê³  í™•ì‹¤í•˜ë©°, í™œë ¥ ë„˜ì¹¨',
                footer: 'ì™„ì „í•œ ìˆ˜ë©´ ì£¼ê¸°ëŠ” ì•½ 90ë¶„ì…ë‹ˆë‹¤. ì£¼ê¸° ëì— ê¹¨ì–´ë‚˜ë©´ ë‡Œê°€ ê°€ì¥ ë§‘ì•„ì ¸ ë©í•¨ê³¼ í”¼ë¡œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
            }
        };

        // å–å¾—ç¿»è­¯æ–‡å­—
        const getText = (key) => {
            return translations[language][key] || key;
        };

        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (State) ---
        let language = 'zh-TW'; // é è¨­ç‚ºç¹é«”ä¸­æ–‡
        let mode = 'wake'; // 'wake', 'sleep', 'now'
        let inputTime = '07:00';
        let useLatency = true;
        let results = [];
        let currentTime = new Date();
        let timer = null;

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const langSelector = document.getElementById('language-selector');
        const appTitle = document.getElementById('app-title');
        const modeSelector = document.getElementById('mode-selector');
        const inputArea = document.getElementById('input-area');
        const latencyToggle = document.getElementById('latency-toggle');
        const latencyHint = document.getElementById('latency-hint');
        const resultsTitle = document.getElementById('results-title');
        const resultHint = document.getElementById('result-hint');
        const resultsList = document.getElementById('results-list');
        const appFooter = document.getElementById('app-footer');


        // --- è¼”åŠ©å‡½å¼ ---

        // æ™‚é–“æ ¼å¼åŒ– (12 å°æ™‚åˆ¶ AM/PM)
        const formatTime = (date) => {
            if (isNaN(date.getTime())) return '--:--';
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            const strMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${hours}:${strMinutes} ${ampm}`;
        };

        // æª¢æŸ¥ä¸¦é™åˆ¶è¼¸å…¥ç‚ºæ•¸å­— (0-9)
        const sanitizeInput = (val) => {
            return val.replace(/\D/g, '').substring(0, 2);
        };
        
        // è™•ç†å°æ™‚è®Šæ›´
        const handleHourChange = (e) => {
            let val = sanitizeInput(e.target.value);
            if (val !== '' && parseInt(val) > 23) {
                val = '23'; // é™åˆ¶æœ€å¤§ 23
            }
            const currentMinute = inputTime.split(':')[1] || '00';
            inputTime = `${val}:${currentMinute}`;
        };

        // è™•ç†åˆ†é˜è®Šæ›´
        const handleMinuteChange = (e) => {
            let val = sanitizeInput(e.target.value);
            if (val !== '' && parseInt(val) > 59) {
                val = '59'; // é™åˆ¶æœ€å¤§ 59
            }
            const currentHour = inputTime.split(':')[0] || '00';
            inputTime = `${currentHour}:${val}`;
        };

        // å¤±å»ç„¦é»æ™‚è‡ªå‹•è£œé›¶ä¸¦è§¸ç™¼è¨ˆç®—
        const handleBlur = (type) => {
            let [h, m] = inputTime.split(':');
            
            if (type === 'hour') {
                if (h === '' || isNaN(parseInt(h))) h = '00';
                else h = parseInt(h).toString().padStart(2, '0');
            }
            
            if (type === 'minute') {
                if (m === '' || isNaN(parseInt(m))) m = '00';
                else m = parseInt(m).toString().padStart(2, '0');
            }

            inputTime = `${h}:${m}`;
            // é‡æ–°æ¸²æŸ“è¼¸å…¥æ¡†ä»¥é¡¯ç¤ºè£œé›¶çµæœ
            renderInputArea(); 
            // è§¸ç™¼è¨ˆç®—
            calculateCycles();
        };

        // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
        const calculateCycles = () => {
            let baseTime = new Date();
            const latencyMinutes = useLatency ? 15 : 0;
            const cycleLength = 90; // 90åˆ†é˜ä¸€å€‹é€±æœŸ

            if (mode === 'now') {
                baseTime = new Date();
            } else {
                const [hoursStr, minutesStr] = inputTime.split(':');
                const hours = parseInt(hoursStr);
                const minutes = parseInt(minutesStr);
                
                if (isNaN(hours) || isNaN(minutes) || hoursStr === '' || minutesStr === '') {
                    results = [];
                    renderResults();
                    return;
                }
                
                baseTime.setHours(hours, minutes, 0, 0);
            }

            const calculatedResults = [];

            for (let i = 1; i <= 6; i++) {
                let resultDate = new Date(baseTime.getTime());
                let totalMinutesChange = 0;

                if (mode === 'wake') {
                    // å€’æ¨ç¡è¦ºæ™‚é–“ï¼šèµ·åºŠæ™‚é–“ - (é€±æœŸ * 90) - å…¥ç¡æ™‚é–“
                    totalMinutesChange = -(i * cycleLength) - latencyMinutes;
                } else {
                    // å¾€å¾Œæ¨èµ·åºŠæ™‚é–“ï¼šç¡è¦ºæ™‚é–“ + å…¥ç¡æ™‚é–“ + (é€±æœŸ * 90)
                    totalMinutesChange = (i * cycleLength) + latencyMinutes;
                }

                resultDate.setMinutes(resultDate.getMinutes() + totalMinutesChange);
                
                let status = { color: '', textKey: '', descriptionKey: '', icon: '' };
                
                if (i <= 2) {
                    status = {
                        color: 'bg-red-500/10 border-red-500/50 text-red-200',
                        badge: 'bg-red-500 text-white',
                        textKey: 'status_short_1',
                        descriptionKey: 'status_desc_1',
                        icon: 'âš ï¸' 
                    };
                } else if (i <= 4) {
                    status = {
                        color: 'bg-orange-500/10 border-orange-500/50 text-orange-200',
                        badge: 'bg-orange-500 text-white',
                        textKey: 'status_short_2',
                        descriptionKey: 'status_desc_2',
                        icon: 'â„¹ï¸' 
                    };
                } else {
                    status = {
                        color: 'bg-emerald-500/10 border-emerald-500/50 text-emerald-200',
                        badge: 'bg-emerald-500 text-white',
                        textKey: 'status_short_3',
                        descriptionKey: 'status_desc_3',
                        icon: 'âœ…' 
                    };
                }

                calculatedResults.push({
                    cycles: i,
                    time: formatTime(resultDate),
                    duration: (i * 1.5).toFixed(1), // 90min = 1.5hr
                    status: status
                });
            }

            calculatedResults.sort((a, b) => b.cycles - a.cycles);
            results = calculatedResults;
            renderResults();
        };


        // --- UI æ¸²æŸ“å‡½å¼ ---

        // æ¸²æŸ“æ¨¡å¼é¸æ“‡æŒ‰éˆ•
        const renderModeSelector = () => {
            const modes = [
                { id: 'sleep', key: 'mode_sleep', icon: 'ğŸ›ï¸' },
                { id: 'wake', key: 'mode_wake', icon: 'â˜€ï¸' },
                { id: 'now', key: 'mode_now', icon: 'â°' }
            ];

            modeSelector.innerHTML = modes.map(m => `
                <button
                    data-mode="${m.id}"
                    class="py-2 px-1 rounded-lg text-sm font-medium transition-all flex flex-col items-center justify-center gap-1 ${
                        mode === m.id ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'
                    }"
                    onclick="setAppMode('${m.id}')"
                >
                    <span class="text-lg">${m.icon}</span>
                    ${getText(m.key)}
                </button>
            `).join('');
        };

        // æ¸²æŸ“è¼¸å…¥å€åŸŸ (æ™‚é–“è¼¸å…¥æˆ–ç•¶å‰æ™‚é–“)
        const renderInputArea = () => {
            inputArea.innerHTML = '';
            
            if (mode === 'now') {
                inputArea.innerHTML = `
                    <div class="text-center py-2">
                        <p class="text-slate-400 text-sm mb-1">${getText('label_current_time')}</p>
                        <p id="current-time-display" class="text-3xl font-mono font-bold text-white tracking-wider">
                            ${currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </p>
                    </div>
                `;
            } else {
                const [h, m] = inputTime.split(':');
                const labelKey = mode === 'wake' ? 'label_wake' : 'label_sleep';

                inputArea.innerHTML = `
                    <div class="flex flex-col items-center">
                        <label class="text-slate-400 text-sm mb-4">
                            ${getText(labelKey)}
                        </label>
                        
                        <div class="flex items-center justify-center space-x-2 bg-slate-900 border-2 border-slate-700 rounded-2xl p-4 shadow-inner focus-within:border-purple-500 focus-within:ring-2 focus-within:ring-purple-500/20 transition-all">
                            <div class="relative">
                                <input
                                    id="hour-input"
                                    type="text"
                                    inputmode="numeric"
                                    value="${h}"
                                    class="w-20 bg-transparent text-white text-5xl font-mono text-center focus:outline-none placeholder-slate-600"
                                    placeholder="HH"
                                    maxlength="2"
                                />
                                <span class="absolute -bottom-4 left-0 w-full text-center text-[10px] text-slate-500 tracking-wider">${getText('label_hour')}</span>
                            </div>
                            
                            <span class="text-4xl text-slate-500 font-light pb-2">:</span>
                            
                            <div class="relative">
                                <input
                                    id="minute-input"
                                    type="text"
                                    inputmode="numeric"
                                    value="${m}"
                                    class="w-20 bg-transparent text-white text-5xl font-mono text-center focus:outline-none placeholder-slate-600"
                                    placeholder="MM"
                                    maxlength="2"
                                />
                                <span class="absolute -bottom-4 left-0 w-full text-center text-[10px] text-slate-500 tracking-wider">${getText('label_minute')}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // é‡æ–°æ›è¼‰äº‹ä»¶ç›£è½å™¨
                document.getElementById('hour-input').addEventListener('input', handleHourChange);
                document.getElementById('hour-input').addEventListener('blur', () => handleBlur('hour'));
                document.getElementById('hour-input').addEventListener('focus', (e) => e.target.select());

                document.getElementById('minute-input').addEventListener('input', handleMinuteChange);
                document.getElementById('minute-input').addEventListener('blur', () => handleBlur('minute'));
                document.getElementById('minute-input').addEventListener('focus', (e) => e.target.select());
            }
        };
        
        // æ¸²æŸ“å…¥ç¡ç·©è¡é–‹é—œ
        const renderLatencyToggle = () => {
            const toggleClass = useLatency ? 'bg-purple-600' : 'bg-slate-600';
            const switchClass = useLatency ? 'translate-x-6' : 'translate-x-0';

            latencyToggle.innerHTML = `
                <div class="w-12 h-6 rounded-full p-1 transition-colors ${toggleClass}">
                    <div class="w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${switchClass}"></div>
                </div>
                <span class="text-sm text-slate-300 select-none">
                    ${getText('latency_label')}
                </span>
            `;
            
            latencyHint.textContent = getText('latency_hint');
            latencyHint.classList.toggle('hidden', !useLatency);
        };

        // æ¸²æŸ“è¨ˆç®—çµæœåˆ—è¡¨
        const renderResults = () => {
            resultsList.innerHTML = '';
            
            resultsTitle.textContent = getText('results_title');
            resultHint.textContent = mode === 'wake' ? getText('hint_wake') : getText('hint_sleep');
            appTitle.textContent = getText('title');
            appFooter.textContent = getText('footer');


            results.forEach(item => {
                const resultItem = document.createElement('div');
                resultItem.className = `relative border-l-4 rounded-r-xl p-4 transition-all hover:brightness-110 ${item.status.color}`;
                resultItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider ${item.status.badge}">
                                ${item.cycles} ${getText('cycles')}
                            </span>
                            <span class="text-xs opacity-70">(${item.duration} ${getText('hours')})</span>
                        </div>
                        <div class="flex items-center space-x-1 text-xs font-medium opacity-90">
                            <span>${item.status.icon}</span>
                            <span>${getText(item.status.textKey)}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end">
                        <div class="text-3xl font-bold tracking-tight">
                            ${item.time}
                        </div>
                        <div class="text-xs max-w-[50%] text-right opacity-80 leading-tight">
                            ${getText(item.status.descriptionKey)}
                        </div>
                    </div>
                `;
                resultsList.appendChild(resultItem);
            });
        };

        // ç¸½é«”æ¸²æŸ“å‡½å¼
        const renderApp = () => {
            renderModeSelector();
            renderInputArea();
            renderLatencyToggle();
            // renderResults() åœ¨ calculateCycles() å…§éƒ¨èª¿ç”¨
            calculateCycles();
        };

        // --- äº‹ä»¶è™•ç†å‡½å¼ ---
        
        window.setAppMode = (newMode) => {
            mode = newMode;
            renderApp();
        };

        window.toggleLatency = () => {
            useLatency = !useLatency;
            renderLatencyToggle();
            calculateCycles();
        };

        // èªè¨€åˆ‡æ›è™•ç†
        langSelector.addEventListener('change', (e) => {
            language = e.target.value;
            renderApp();
        });
        
        // --- åˆå§‹åŒ–èˆ‡ä¸»å¾ªç’° ---

        const init = () => {
            // 1. è¨­ç½®å®šæ™‚å™¨æ›´æ–°ç¾åœ¨æ™‚é–“ (æ¨¡æ“¬ React useEffect)
            timer = setInterval(() => {
                currentTime = new Date();
                if (mode === 'now') {
                    // å¦‚æœåœ¨ 'now' æ¨¡å¼ï¼Œæ¯ç§’æ›´æ–°é¡¯ç¤ºæ™‚é–“å’Œè¨ˆç®—çµæœ
                    const display = document.getElementById('current-time-display');
                    if (display) {
                         display.textContent = currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    calculateCycles();
                }
            }, 1000);
            
            // 2. åˆå§‹æ¸²æŸ“
            renderApp();
        };

        // ç¢ºä¿ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ
        window.onload = init;
    </script>

</body>
</html>